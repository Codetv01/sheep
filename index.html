<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/PC.css" class="equipment">
    <title>羊了个羊简易版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .operation {
            width: 80px;
            height: 40px;
            position: fixed;
            background-color: #FFA042;
            border-radius: 3px;
            border: 1px solid #FFA042;
            color: #531c01;
            border: none;
            padding: 3px;
            bottom: 90px;
        }

        .disorganize {
            left: 30px;
        }

        .selectLevel {
            left: 155px;
        }

        .reset {
            left: 280px;
        }

        .audio {
            position: fixed;
            top: 3px;
            left: 3px;
            color: #cf6800;
            background-color: white;
            border: none;
            font-weight: 800;
            font-size: 16px;
        }

        @keyframes fade {
            100% {
                opacity: 0.2;
                transform: scale(0.5);
            }
        }

        @keyframes enter {
            0% {
                transform: scale(0);
            }
        }
    </style>
</head>

<body>
    <button class="audio"><?xml version="1.0" encoding="UTF-8"?><svg width="25" height="25" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M30 34.5C30 32.567 31.567 31 33.5 31H41V34.4C41 36.3882 39.3882 38 37.4 38H33.5C31.567 38 30 36.433 30 34.5Z" fill="none" stroke="#ee830e" stroke-width="4" stroke-linejoin="round"/><path d="M6 38.5C6 36.567 7.567 35 9.5 35H16V38.4C16 40.3882 14.3882 42 12.4 42H9.5C7.567 42 6 40.433 6 38.5Z" fill="none" stroke="#ee830e" stroke-width="4" stroke-linejoin="round"/><path d="M16 18.044V18.044L41 12.125" stroke="#ee830e" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><path d="M16 38V10L41 4V33.6924" stroke="#ee830e" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
    <button class="disorganize operation">随机打乱</button>
    <button class="reset operation">重新开始</button>

    <select class="selectLevel operation">
        <option value="6">第一关</option>
        <option value="12">第二关</option>
        <option value="20">第三关</option>
        <option value="30">第四关</option>
        <option value="40">第五关</option>
        <option value="50">第六关</option>
        <option value="60">第七关</option>
        <option value="70">第八关</option>
        <option value="85">第九关</option>
        <option value="100">第十关</option>
    </select>

    <div class="box"></div>

    <audio muted autoplay src="audio/失败.mp3"></audio>
    <audio muted autoplay src="audio/胜利2.mp3"></audio>
    <audio autoplay loop src="audio/背景音乐.mp3" class="BGAudio"></audio>
    <audio autoplay src="audio/得分.mp3" class="audioScore"></audio>
    <audio autoplay class="audioFinish"></audio>

    <script>
        const box = document.querySelector('.box');
        const body = document.body;
        let allGoods = document.querySelectorAll('.goods');
        let boxGoodsLeft = 0;
        let boxVolume = 0;
        let spacing = 65;
        const selectLevel = document.querySelector('.selectLevel');
        const disorganize = document.querySelector('.disorganize');
        const reset = document.querySelector('.reset');
        const BGAudio = document.querySelector('.BGAudio');
        const audio = document.querySelector('.audio');
        const audioScore = document.querySelector('.audioScore');
        const audioFinish = document.querySelector('.audioFinish');

        const goodsList = [{
            mark: 1,
            BP: 'zoon1'
        }, {
            mark: 2,
            BP: 'zoon2'
        }, {
            mark: 3,
            BP: 'zoon3'
        }, {
            mark: 4,
            BP: 'zoon4'
        }, {
            mark: 5,
            BP: 'zoon5'
        }, {
            mark: 6,
            BP: 'zoon6'
        }, {
            mark: 7,
            BP: 'zoon7'
        }, {
            mark: 8,
            BP: 'zoon8'
        }, {
            mark: 9,
            BP: 'zoon9'
        }]

        function randomNum(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // 如果是移动端，则更换css文件，并调整goods间隙
        if (/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
            const equipment = document.querySelector('.equipment');
            equipment.setAttribute('href', 'css/mobile.css');
            spacing = 48;
        }

        function createGoods(oneGoods) {
            const goods = document.createElement('div');
            goods.classList.add('goods');
            goods.style.backgroundImage = `url(imgs/${oneGoods.BP}.png)`;
            goods.setAttribute('mark', oneGoods.mark)
            goods.style.top = randomNum(50, window.innerHeight - 222) + 'px';
            goods.style.left = randomNum(20, window.innerWidth - 70) + 'px';
            body.appendChild(goods);
            goods.setAttribute('onclick', 'goodsClick(this)');
        }

        function goodsClick(self) {
            if (boxVolume >= 7) return;
            createdAudio('audio/点击.mp3');
            const newGoods = self.cloneNode();
            newGoods.style.top = 0;
            newGoods.style.left = boxGoodsLeft + 'px';
            newGoods.removeAttribute('onclick');
            boxGoodsLeft += spacing;
            boxVolume++;
            newGoods.style.opacity = 0;
            box.appendChild(newGoods);
            self.style.transition = 'top .4s, left .4s';
            self.style.top = box.offsetTop + 2 + 'px';
            self.style.left = boxGoodsLeft + box.offsetLeft - self.offsetWidth + 'px';
            setTimeout(() => {
                newGoods.style.opacity = 1;
                self.remove();
            }, 400);
            let count = 0;
            let children = [...box.children];
            children.forEach(item => item.getAttribute('mark') == newGoods.getAttribute('mark') && count++);
            // 防止删除三个以上
            let index = 0;
            if (count >= 3) {
                audioScore.play();
                children.forEach(item => {
                    if (item.getAttribute('mark') == newGoods.getAttribute('mark')) {
                        if(index >= 3) return;
                        index++;
                        item.style.animation = 'fade .3s linear';
                        setTimeout(() => {
                            item.remove();
                            children = [...box.children];
                            boxGoodsLeft = spacing * children.length
                            children.forEach((item, index) => {
                                item.style.transition = 'left .2s';
                                item.style.left = index * spacing + 'px';
                            });
                        }, 200);
                    }
                });
                boxVolume -= 3;
            }
            boxVolume >= 7 && gameFinish('很遗憾你输了', 'audio/失败.mp3');
            setTimeout(() => {
                allGoods = document.querySelectorAll('.goods');
                allGoods.length <= 0 && gameFinish('恭喜你胜利了', 'audio/胜利2.mp3');
            }, 450);
        }

        function gameFinish(str, audio) {
            setTimeout(() => alert(str), 200);
            audioFinish.setAttribute('src', audio);
            audioFinish.play();
        }

        function gameStart(number) {
            boxVolume = 0;
            boxGoodsLeft = 0;
            allGoods.forEach(item => item.remove());
            for (let i = 0; i < number; i++) {
                const num = randomNum(0, goodsList.length - 1);
                for (let i = 0; i < 3; i++) {
                    createGoods(goodsList[num]);
                }
            }
            allGoods = document.querySelectorAll('.goods');
            allGoods.forEach(item => item.style.animation = `enter .3s`);
        }

        gameStart(10);

        selectLevel.addEventListener('input', () => gameStart(selectLevel.value));

        disorganize.addEventListener('click', () => {
            allGoods.forEach(item => {
                if (!item.getAttribute('onclick')) return;
                item.style.transition = 'top .8s, left .5s';
                item.style.top = randomNum(50, window.innerHeight - 222) + 'px';
                item.style.left = randomNum(20, window.innerWidth - 70) + 'px';
            });
        });

        reset.addEventListener('click', () => gameStart(selectLevel.value));

        let audioThrottling = false;

        function createdAudio(src) {
            if (audioThrottling) return;
            audioThrottling = true;
            setTimeout(() => audioThrottling = false, 200);
            let audio = document.createElement('audio');
            document.body.appendChild(audio);
            audio.autoplay = true;
            audio.setAttribute('src', src);
            audio.play();
            audio.addEventListener('ended', e => e.target.remove());
        }

        audio.addEventListener('click', () => {
            BGAudio.setAttribute('src', 'audio/背景音乐.mp3');
            BGAudio.volume = 0.8;
            BGAudio.play();
        });
    </script>
</body>

</html>